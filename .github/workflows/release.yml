name: Release Package

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package name"
        required: true
        type: choice
        options:
          - rajeshdas
      version_component:
        description: "Version component to bump (optional if already pre-release)"
        required: false
        type: choice
        default: "none"
        options:
          - none
          - patch
          - minor
          - major
      prerelease:
        description: "Pre-release type (optional, 'stable' removes pre-release)"
        required: false
        type: choice
        default: "none"
        options:
          - none
          - stable
          - alpha
          - beta
          - rc
          - post
          - dev

# Prevent concurrent releases for the same package
concurrency:
  group: release-${{ inputs.package }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0 # Fetch all history for changelog generation

      - name: Setup Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7.2.1
        with:
          enable-cache: true

      - name: Validate package exists
        run: |
          if [ ! -d "packages/${{ inputs.package }}" ]; then
            echo "❌ ERROR: Package packages/${{ inputs.package }} not found!"
            exit 1
          fi

      - name: Cache virtual environment
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Create virtual environment
        run: |
          uv venv --python-preference managed
        env:
          VIRTUAL_ENV: .venv

      - name: Bump version
        id: version
        working-directory: packages/${{ inputs.package }}
        run: |
          BUMP_ARGS=""

          # Add version component if specified
          if [ "${{ inputs.version_component }}" != "none" ]; then
            BUMP_ARGS="--bump ${{ inputs.version_component }}"
          fi

          # Add pre-release type if specified
          if [ "${{ inputs.prerelease }}" != "none" ]; then
            BUMP_ARGS="$BUMP_ARGS --bump ${{ inputs.prerelease }}"
          fi

          # Ensure at least one bump option was provided
          if [ -z "$BUMP_ARGS" ]; then
            echo "❌ ERROR: Must specify at least one of: version_component or prerelease"
            exit 1
          fi

          # Execute version bump
          uv version $BUMP_ARGS --no-sync

          VERSION=$(uv version --short)
          echo "new_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4.7.0
        with:
          config: cliff.toml
          args: |
            --include-path "packages/${{ inputs.package }}/**" \
            --tag-pattern "${{ inputs.package }}-v*" \
            --tag "${{ inputs.package }}-v${{ steps.version.outputs.new_version }}"
        env:
          OUTPUT: packages/${{ inputs.package }}/CHANGELOG.md

      - name: Verify changelog
        run: |
          if [ ! -f "packages/${{ inputs.package }}/CHANGELOG.md" ] || [ ! -s "packages/${{ inputs.package }}/CHANGELOG.md" ]; then
            echo "❌ ERROR: CHANGELOG.md was not generated or is empty!"
            exit 1
          fi
          echo "✅ Changelog generated successfully"

      - name: Build package
        run: uv build --package ${{ inputs.package }}

      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.UV_PUBLISH_TOKEN }}
        run: uv publish --package ${{ inputs.package }}

      - name: Generate requirements.txt
        run: uv export --frozen --output-file requirements.txt

      - name: Create pull request
        id: pull_request
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "release/${{ inputs.package }}-v${{ steps.version.outputs.new_version }}"
          base: main
          title: "chore(release): ${{ inputs.package }} v${{ steps.version.outputs.new_version }}"
          body-path: "packages/${{ inputs.package }}/CHANGELOG.md"
          labels: release
          commit-message: "chore(release): ${{ inputs.package }} v${{ steps.version.outputs.new_version }}"
          add-paths: |
            packages/${{ inputs.package }}/pyproject.toml
            packages/${{ inputs.package }}/CHANGELOG.md
            uv.lock
            requirements.txt

      - name: Ensure release PR exists
        if: steps.pull_request.outputs.pull-request-number == ''
        run: |
          echo "❌ Release PR was not created."
          exit 1

      - name: Create git tag
        run: |
          git tag "${{ inputs.package }}-v${{ steps.version.outputs.new_version }}"
          git push origin "${{ inputs.package }}-v${{ steps.version.outputs.new_version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: "${{ inputs.package }}-v${{ steps.version.outputs.new_version }}"
          name: "${{ inputs.package }} v${{ steps.version.outputs.new_version }}"
          body_path: "packages/${{ inputs.package }}/CHANGELOG.md"
          draft: false
          prerelease: false
